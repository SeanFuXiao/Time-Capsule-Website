<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Capsule</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <body>
    <header>
      <h1>View Time Capsule</h1>
      <nav>
        <a href="/dashboard">My Capsule</a>
        <a href="/logout">Logout</a>
      </nav>
    </header>

    <main class="capsule-container">
      <div class="main-content">
        <section class="content-box">
          <h2><%= capsule.title %></h2>
          <p>
            <strong>Unlock Date:</strong> <%= capsule.unlockDate.toDateString()
            %>
          </p>

          <div class="capsule-content">
            <% if (new Date() >= capsule.unlockDate) { %>
            <p><strong>Content:</strong> <%= capsule.content %></p>
            <% } else { %>
            <p class="locked-message">
              The capsule is still locked. You cannot view the content until the
              unlock date.
            </p>
            <% } %>
          </div>

          <h3>Participants</h3>
          <form
            action="/capsules/<%= capsule._id %>/deleteSelectedParticipants"
            method="POST"
            onsubmit="return checkDelete();"
          >
            <div class="participants-actions">
              <div class="participants-list-box">
                <ul class="participants-list">
                  <% if (capsule.participants && capsule.participants.length >
                  0) { %> <% capsule.participants.forEach(participant => { %>
                  <li class="participant-item">
                    <% if (capsule.owner._id.toString() === user._id.toString())
                    { %>

                    <input
                      type="checkbox"
                      class="participantCheckbox"
                      name="selectedParticipants[]"
                      value="<%= participant._id %>"
                    />
                    <% } %>
                    <label class="participant-label"
                      ><%= participant.username %></label
                    >
                  </li>
                  <% }) %> <% } else { %>
                  <li class="empty-message">No participants invited yet.</li>
                  <% } %>
                </ul>
              </div>

              <% if (capsule.owner._id.toString() === user._id.toString()) { %>
              <div class="buttons-box">
                <button type="submit" class="button-secondary delete-button">
                  Delete Selected
                </button>
                <button
                  type="button"
                  onclick="addParticipant()"
                  class="button-secondary add-participant-btn"
                >
                  Add Participant
                </button>
              </div>
              <% } %>
            </div>
          </form>

          <% if (capsule.owner._id.toString() === user._id.toString()) { %>
          <section class="capsule-actions">
            <a href="/capsules/<%= capsule._id %>/edit" class="button-primary"
              >Edit Capsule</a
            >
          </section>
          <% } %>
        </section>

        <section class="comments-box">
          <h3>Comments</h3>
          <ul class="comment-list">
            <% if (comments && comments.length > 0) { %> <%
            comments.forEach(comment => { %>
            <li class="comment-item">
              <strong><%= comment.user.username %>:</strong> <%= comment.content
              %>
              <em>(<%= comment.createdAt.toDateString() %>)</em>
            </li>
            <% }) %> <% } else { %>
            <li class="empty-message">No comments yet.</li>
            <% } %>
          </ul>

          <% if (new Date() >= capsule.unlockDate) { %>
          <form action="/capsules/<%= capsule._id %>/comments" method="POST">
            <textarea
              name="content"
              placeholder="Add your comment..."
              required
            ></textarea>
            <button type="submit" class="button-primary">Add Comment</button>
          </form>
          <% } else { %>
          <p class="locked-message">
            The capsule is still locked. You cannot add comments until it is
            unlocked.
          </p>
          <% } %>
        </section>

        <section class="back-button-container">
          <a href="/dashboard" class="button-primary">Back</a>
        </section>
      </div>
    </main>

    <div id="personal-links">
      <a href="https://github.com/SeanFuXiao" id="github">
        <i class="fab fa-github"></i>
      </a>
      <a href="https://www.linkedin.com/in/xiao-fu-138b96316/" id="linkedin">
        <i class="fab fa-linkedin"></i>
      </a>
      <a
        href="https://www.facebook.com/profile.php?id=100090159947400"
        id="facebook"
      >
        <i class="fab fa-facebook"></i>
      </a>
      <a href="mailto:seanfuxiao@gmail.com" id="email">
        <i class="fas fa-envelope"></i>
      </a>
    </div>

    <footer>
      <p>&copy; 2024 Digital Time Capsule</p>
    </footer>

    <script>
      function addParticipant() {
        const username = prompt("Enter the username to invite:");
        if (username) {
          const form = document.createElement("form");
          form.method = "POST";
          form.action = "/capsules/<%= capsule._id %>/invite";

          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "participant";
          input.value = username;

          form.appendChild(input);
          document.body.appendChild(form);
          form.submit();
        }
      }

      function checkDelete() {
        const selected = document.querySelectorAll(
          ".participantCheckbox:checked"
        );
        if (selected.length === 0) {
          alert("Please select one or more participants to delete.");
          return false;
        }
        return true;
      }
    </script>
  </body>
</html>
