<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Capsule</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <script>
      function showAddParticipant() {
        const addParticipantInput = document.getElementById(
          "addParticipantInput"
        );
        addParticipantInput.style.display = "block";
      }
      function checkDelete() {
        const selected = document.querySelectorAll(
          ".participantCheckbox:checked"
        );
        if (selected.length === 0) {
          alert("Please select one or more participants to delete.");
          return false;
        }
        return true;
      }
    </script>
  </head>
  <body>
    <header>
      <h1>View Time Capsule</h1>
      <nav>
        <a href="/dashboard">Dashboard</a>
        <a href="/logout">Logout</a>
      </nav>
    </header>

    <main>
      <section>
        <h2><%= capsule.title %></h2>
        <p>
          <strong>Unlock Date:</strong> <%= capsule.unlockDate.toDateString() %>
        </p>
        <% if (new Date() >= capsule.unlockDate) { %>
        <p><strong>Content:</strong> <%= capsule.content %></p>
        <% } else { %>
        <p>
          The capsule is still locked. You cannot view the content until the
          unlock date.
        </p>
        <% } %>
      </section>
      <% if (capsule.owner._id.toString() === user._id.toString()) { %>
      <a href="/capsules/<%= capsule._id %>/edit">
        <button>Edit Capsule</button>
      </a>
      <% } %>
      <section>
        <h3>Participants</h3>
        <ul>
          <% if (capsule.participants && capsule.participants.length > 0) { %>
          <% capsule.participants.forEach(participant => { %>
          <li><%= participant.username %></li>
          <% }) %> <% } else { %>
          <li>No participants invited yet.</li>
          <% } %>
        </ul>
      </section>

      <% if (capsule.owner._id.toString() === user._id.toString()) { %>
      <section>
        <button onclick="showAddParticipant()">Add Participant</button>
        <div id="addParticipantInput" style="display: none">
          <form action="/capsules/<%= capsule._id %>/invite" method="POST">
            <input
              type="text"
              id="participant"
              name="participant"
              placeholder="Enter username"
              required
            />
            <button type="submit">Add</button>
          </form>
        </div>
      </section>

      <section>
        <form
          action="/capsules/<%= capsule._id %>/deleteSelectedParticipants"
          method="POST"
          onsubmit="return checkDelete();"
        >
          <button type="submit">Delete Selected</button>
        </form>
      </section>
      <% } %>

      <section>
        <h3>Comments</h3>
        <ul>
          <% if (comments && comments.length > 0) { %> <%
          comments.forEach(comment => { %>
          <li>
            <strong><%= comment.user.username %>:</strong> <%= comment.content
            %>
            <em>(<%= comment.createdAt.toDateString() %>)</em>
          </li>
          <% }) %> <% } else { %>
          <li>No comments yet.</li>
          <% } %>
        </ul>

        <% if (new Date() >= capsule.unlockDate) { %>
        <form action="/capsules/<%= capsule._id %>/comments" method="POST">
          <textarea
            name="content"
            placeholder="Add your comment..."
            required
          ></textarea>
          <button type="submit">Add Comment</button>
        </form>
        <% } else { %>
        <p>
          The capsule is still locked. You cannot add comments until it is
          unlocked.
        </p>
        <% } %>
      </section>
    </main>

    <footer>
      <p>&copy; 2024 Digital Time Capsule</p>
    </footer>
  </body>
</html>
